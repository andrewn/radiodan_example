#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'

require 'faye'
require 'eventmachine'

# Get foreman not to buffer logging output
$stdout.sync = true

$: << './lib'
require 'now_playing_client'

puts "Started"

@faye_url = "http://localhost:3000/faye"

EventMachine.run do
  @now_playing_client = NowPlayingClient.new

  @client = Faye::Client.new(@faye_url)

  @now_playing_client.on_message do |message|
    puts "Now Playing message from #{message[:station_id]}"
    @client.publish('/now_playing', message)
  end
end
